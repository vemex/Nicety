<template>
    <button v-if="!onlyRenderIfCancelable || state.cancelable"
            type="button"
            aria-label="cancel"
            class="vue-fine-uploader-cancel-button"
            :disabled="!state.cancelable"
            @click="_onClick">
        <slot>Cancel</slot>
    </button>
</template>

<style lang="css"></style>

<script>
    const isCancelable = status => {
        return [
            'delete failed',
            'paused',
            'queued',
            'retrying upload',
            'submitted',
            'uploading',
            'upload failed'
        ].indexOf(status) >= 0
    };

    export default {
        props: {
            id: {
                type: Number,
                required: true
            },
            onlyRenderIfCancelable: {
                type: Boolean,
                default: true
            },
            uploader: {
                type: Object,
                required: true
            }
        },

        data () {
            return {
                state: {
                    cancelable: true
                },
                _unmounted: false
            }
        },

        mounted () {
            this.uploader.on('statusChange', this._onStatusChange);
            let file= this.uploader.methods._uploadData.retrieve(this.id);
            if (file.length>0) {
                this._onStatusChange(this.id, file[0].status,file[0].status);
            }
        },

        beforeDestroy () {
            this._unmounted = true;
            this._unregisterStatusChangeHandler()
        },

        methods: {
            _onStatusChange (id, oldStatus, newStatus) {
                if (id === this.id && !this._unmounted) {
                    if (!isCancelable(newStatus) && this.state.cancelable) {
                        this.$set(this.state, 'cancelable', false)
                    } else if (isCancelable(newStatus) && !this.state.cancelable) {
                        this.$set(this.state, 'cancelable', true)
                    } else if (newStatus === 'deleted' || newStatus === 'canceled') {
                        this._unregisterStatusChangeHandler()
                    }
                }
            },

            _onClick () {
                if (this.state.cancelable) {
                    this.uploader.methods.cancel(this.id)
                }
            },

            _unregisterStatusChangeHandler () {
                this.uploader.off('statusChange', this._onStatusChange)
            }
        }
    }
</script>
